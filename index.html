<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kasir Toko & Pesanan Masuk</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CSS Internal -->
    <style>
        :root {
            --slate-50: #f8fafc; --slate-100: #f1f5f9; --slate-200: #e2e8f0; --slate-300: #cbd5e1; --slate-400: #94a3b8;
            --slate-500: #64748b; --slate-600: #475569; --slate-700: #334155; --slate-800: #1e293b;
            --slate-900: #0f172a; --white: #ffffff;
            --primary-50: #f0fdf4; --primary-100: #dcfce7; --primary-500: #22c55e; --primary-600: #16a34a; --primary-700: #15803d;
            --red-500: #ef4444; --red-700: #b91c1c;
            --amber-100: #fef3c7; --amber-500: #f59e0b;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--slate-50); margin: 0; color: var(--slate-700); }
        .hidden { display: none !important; }
        
        #app { display: flex; flex-direction: column; height: 100vh; }
        @media (min-width: 1280px) { #app { flex-direction: row; } }
        
        .products-section { width: 100%; padding: 1.5rem; display: flex; flex-direction: column; order: 2; }
        @media (min-width: 1280px) { .products-section { width: 45%; order: 1; } }

        .order-section { width: 100%; background-color: var(--white); padding: 1.5rem; display: flex; flex-direction: column; box-shadow: 0 -2px 4px rgba(0,0,0,0.05); border-top: 4px solid var(--primary-500); order: 3; }
        @media (min-width: 1280px) { .order-section { width: 25%; box-shadow: -2px 0 4px rgba(0,0,0,0.05); border-top: none; border-left: 4px solid var(--primary-500); order: 2; } }
        
        .incoming-orders-section { width: 100%; background-color: var(--amber-100); padding: 1.5rem; display: flex; flex-direction: column; order: 1; height: 50vh; overflow-y: auto; }
        @media (min-width: 1280px) { .incoming-orders-section { width: 30%; border-right: 4px solid var(--amber-500); order: 3; height: 100vh; } }

        header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        h1 { font-size: 1.875rem; font-weight: 700; color: var(--primary-700); margin: 0; }
        h2 { font-size: 1.5rem; font-weight: 700; color: var(--slate-800); margin-bottom: 1rem; border-bottom: 1px solid var(--slate-200); padding-bottom: 1rem; }
        h2 .order-count { background-color: var(--amber-500); color: white; font-size: 1rem; padding: 0.25rem 0.75rem; border-radius: 99px; margin-left: 0.5rem; }
        p { color: var(--slate-500); margin-top: 0.25rem; }
        
        .search-bar { width: 100%; padding: 0.75rem; border: 1px solid var(--slate-300); border-radius: 0.5rem; margin-bottom: 1.5rem; box-sizing: border-box; font-size: 1rem; }
        .product-list { flex-grow: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; padding: 0.5rem; }
        @media (min-width: 768px) { .product-list { grid-template-columns: repeat(3, 1fr); } }
        
        .product-card { background-color: var(--white); border-radius: 0.75rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); border: 1px solid var(--slate-200); cursor: pointer; display: flex; flex-direction: column; justify-content: center; padding: 1rem; min-height: 100px; transition: all 0.2s ease-in-out; }
        .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); border-color: var(--primary-500); }
        .product-card h3 { font-weight: 600; margin: 0 0 0.25rem 0; font-size: 1rem; }
        .product-card p { font-size: 1.125rem; font-weight: 700; color: var(--primary-600); margin: 0; }
        
        .cart-items, #order-list { flex-grow: 1; overflow-y: auto; }
        .empty-cart, .empty-order { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--slate-400); text-align: center; }
        
        .cart-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding: 0.75rem; border-radius: 0.5rem; background-color: var(--slate-50); }
        .cart-item-controls { display: flex; align-items: center; gap: 0.75rem; }
        .cart-item-controls button { background-color: var(--slate-200); width: 28px; height: 28px; border-radius: 9999px; font-weight: 700; border: none; cursor: pointer; }
        .remove-btn { color: var(--red-500); background: none; border: none; font-size: 1.25rem; cursor: pointer; }

        .order-card { background-color: var(--white); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .order-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .order-card-header h3 { font-size: 1.125rem; margin: 0; color: var(--slate-800); }
        .order-card-header span { font-size: 0.875rem; color: var(--slate-500); }
        .order-card-body p { margin: 0.25rem 0; font-size: 0.9rem; }
        .order-card-items { font-style: italic; color: var(--slate-600); margin-top: 0.5rem; font-size: 0.9rem; }
        .order-card-footer { margin-top: 0.75rem; font-weight: 700; text-align: right; font-size: 1.1rem; color: var(--primary-700); }

        .summary { margin-top: auto; padding-top: 1.5rem; border-top: 1px solid var(--slate-200); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .summary-row.total { font-size: 1.25rem; font-weight: 700; color: var(--slate-900); }
        .pay-button, .btn-secondary { padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; }
        .pay-button { width: 100%; background-color: var(--primary-600); color: var(--white); margin-top: 1.5rem; font-size: 1.125rem; }
        .pay-button:disabled { background-color: var(--slate-300); cursor: not-allowed; }
        .btn-secondary { background-color: var(--slate-200); color: var(--slate-800); }

        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: var(--white); border-radius: 0.5rem; padding: 2rem; width: 100%; max-width: 448px; margin: 1rem; }
        .modal-content-lg { max-width: 768px; }
        
        #sales-report-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        #sales-report-table th, #sales-report-table td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--slate-200); }
        
        /* Modal Pembayaran */
        .payment-methods { display: flex; gap: 1rem; margin-bottom: 1.5rem; }
        .payment-method { flex: 1; padding: 1rem; border: 2px solid var(--slate-200); border-radius: 0.5rem; text-align: center; cursor: pointer; }
        .payment-method.selected { border-color: var(--primary-500); background-color: var(--primary-50); }
        #qris-container { text-align: center; }
        #qris-image { max-width: 250px; margin: 1rem auto; display: block; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input { width: 100%; padding: 0.75rem; border: 1px solid var(--slate-300); border-radius: 0.5rem; box-sizing: border-box; }
        
    </style>
</head>
<body>
    <div id="app">
        <!-- Bagian Produk -->
        <div class="products-section">
            <header>
                <div>
                    <h1>DAPUR OMAH</h1>
                    <p>Sistem Kasir (Penjualan Offline)</p>
                </div>
                <button id="sales-report-btn" class="btn-secondary">Laporan Penjualan</button>
            </header>
            <input type="text" id="search-product" placeholder="Ketik untuk mencari produk..." class="search-bar">
            <div id="product-list" class="product-list"><p>Memuat produk...</p></div>
        </div>
        
        <!-- Bagian Pesanan Saat Ini -->
        <div class="order-section">
            <h2>Pesanan Saat Ini</h2>
            <div id="cart-items" class="cart-items">
                <div id="empty-cart" class="empty-cart">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 1rem;"><path d="m5 11 4-7"/><path d="m19 11-4-7"/><path d="M2 11h20"/><path d="m3.5 11 1.6 7.4a2 2 0 0 0 2 1.6h9.8c.9 0 1.8-.7 2-1.6l1.7-7.4"/><path d="m9 11 1 9"/><path d="M4.5 15.5h15"/><path d="m15 11-1 9"/></svg>
                    <p>Keranjang masih kosong</p>
                </div>
            </div>
            <div class="summary">
                <div class="summary-row"><span>Subtotal</span><span id="subtotal">Rp 0</span></div>
                <div class="summary-row total"><span>Total</span><span id="total">Rp 0</span></div>
                <button id="pay-button" class="pay-button" disabled>BAYAR</button>
            </div>
        </div>

        <!-- FITUR BARU: Bagian Pesanan Masuk -->
        <div class="incoming-orders-section">
            <h2>Pesanan Masuk <span id="order-count" class="order-count">0</span></h2>
            <div id="order-list">
                <div id="empty-order" class="empty-order">
                    <p>Memuat pesanan masuk...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Pembayaran -->
    <div id="payment-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-top:0;">Pembayaran</h3>
            <p>Total Tagihan: <strong id="modal-total" style="font-size: 1.25rem;"></strong></p>
            <div class="payment-methods">
                <div id="method-cash" class="payment-method selected">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 0.5rem;"><rect width="20" height="12" x="2" y="6" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>
                    <span>Tunai</span>
                </div>
                <div id="method-qris" class="payment-method">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 0.5rem;"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16.01V12"/></svg>
                    <span>QRIS</span>
                </div>
            </div>
            <div id="cash-container">
                <div class="form-group">
                    <label for="cash-amount">Jumlah Uang</label>
                    <input type="text" id="cash-amount" placeholder="Contoh: 50000">
                </div>
                <p>Kembalian: <strong id="change-amount">Rp 0</strong></p>
            </div>
            <div id="qris-container" class="hidden">
                <p>Pindai kode QR di bawah ini untuk membayar:</p>
                <img id="qris-image" src="" alt="QRIS Code">
            </div>
            <div style="display:flex; gap: 1rem; margin-top: 1.5rem;">
                <button id="cancel-payment-btn" class="btn-secondary" style="width: 100%;">Batal</button>
                <button id="process-payment-btn" class="pay-button" style="width: 100%; margin:0;">Proses</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Struk -->
    <div id="receipt-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div id="receipt-content" style="font-family: monospace;"></div>
            <div style="display:flex; gap: 1rem; margin-top: 1.5rem;">
                <button id="close-receipt-btn" class="btn-secondary" style="width: 100%;">Tutup</button>
                <button id="print-receipt-btn" class="pay-button" style="width: 100%; margin:0;">Cetak Struk</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Laporan Penjualan -->
    <div id="sales-report-modal" class="modal-overlay hidden">
        <div class="modal-content modal-content-lg">
             <h3 style="margin-top:0;">Laporan Penjualan</h3>
             <div style="max-height: 400px; overflow-y: auto;">
                <table id="sales-report-table">
                    <thead><tr><th>Waktu</th><th>Item</th><th>Total</th></tr></thead>
                    <tbody id="sales-report-body"></tbody>
                </table>
             </div>
             <p style="text-align: right; font-size: 1.125rem; margin-top: 1rem;"><strong>Total Pendapatan: <span id="report-summary"></span></strong></p>
             <div style="display:flex; gap: 1rem; margin-top: 1.5rem;">
                <button id="clear-report-btn" style="background-color: var(--red-700); color: white;" class="btn-secondary">Hapus Laporan</button>
                <button id="close-report-btn" class="btn-secondary">Tutup</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- URL KONFIGURASI ---
            const GOOGLE_SHEET_PRODUCTS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTxVL5u6i9rJqT3IbjyDPhlbHk5fnWj4cxO-W8pXJNhlxnS7eXtKAot8w1XbZh4rcMM4jZeBr7-HOlJ/pub?output=csv';
            const GOOGLE_SHEET_ORDERS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQO_89pG9UpQp2iGkFO2axyxkuonb1eSIJkhFmljs2NdJmcz_K2uAbDdkN6_h-O8znKcKlsfLjw3y2b/pub?gid=1139337221&single=true&output=csv';
            const QRIS_IMAGE_URL = 'https://i.imgur.com/uILbqf3.png';
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_MR7puDd465jpwKVCQ2OWCAyBYM9idswe6nKJ68ElfZUkbG4vN7VI0UzTRY_8JIBw-g/exec';

            // --- STATE APLIKASI ---
            let allProducts = [];
            let incomingOrders = []; 
            let cart = [];
            let salesData = [];
            let currentPaymentMethod = 'cash';
            let totalAmount = 0;

            const DOM = {
                productList: document.getElementById('product-list'),
                cartItems: document.getElementById('cart-items'),
                subtotal: document.getElementById('subtotal'),
                total: document.getElementById('total'),
                payButton: document.getElementById('pay-button'),
                searchInput: document.getElementById('search-product'),
                emptyCart: document.getElementById('empty-cart'),
                orderList: document.getElementById('order-list'),
                emptyOrder: document.getElementById('empty-order'),
                orderCount: document.getElementById('order-count'),
                paymentModal: document.getElementById('payment-modal'),
                modalTotal: document.getElementById('modal-total'),
                cashAmountInput: document.getElementById('cash-amount'),
                changeAmount: document.getElementById('change-amount'),
                processPaymentBtn: document.getElementById('process-payment-btn'),
                cancelPaymentBtn: document.getElementById('cancel-payment-btn'),
                receiptModal: document.getElementById('receipt-modal'),
                receiptContent: document.getElementById('receipt-content'),
                closeReceiptBtn: document.getElementById('close-receipt-btn'),
                printReceiptBtn: document.getElementById('print-receipt-btn'),
                salesReportModal: document.getElementById('sales-report-modal'),
                salesReportBtn: document.getElementById('sales-report-btn'),
                salesReportBody: document.getElementById('sales-report-body'),
                reportSummary: document.getElementById('report-summary'),
                clearReportBtn: document.getElementById('clear-report-btn'),
                closeReportBtn: document.getElementById('close-report-btn'),
                methodCash: document.getElementById('method-cash'),
                methodQris: document.getElementById('method-qris'),
                cashContainer: document.getElementById('cash-container'),
                qrisContainer: document.getElementById('qris-container'),
                qrisImage: document.getElementById('qris-image'),
            };

            const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
            
            async function fetchWithRetry(url, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        return await fetch(url);
                    } catch (error) {
                        if (i < retries - 1) {
                            await new Promise(res => setTimeout(res, delay));
                        } else {
                            throw error;
                        }
                    }
                }
            }

            // --- FUNGSI DATA ---
            async function fetchProducts() {
                try {
                    const response = await fetchWithRetry(GOOGLE_SHEET_PRODUCTS_URL);
                    const csvText = await response.text();
                    const lines = csvText.trim().split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    allProducts = lines.slice(1).map(line => {
                        const values = line.split(',');
                        const product = {};
                        headers.forEach((header, i) => product[header] = values[i] ? values[i].trim() : '');
                        product.price = parseFloat(product.price) || 0;
                        return product;
                    }).filter(p => p.name && p.price > 0);
                    renderProducts(allProducts);
                } catch (error) {
                    console.error('Gagal mengambil data produk:', error);
                    DOM.productList.innerHTML = `<p style="color: var(--red-700);">Gagal memuat produk. Cek koneksi internet Anda.</p>`;
                }
            }

            async function fetchOrders() {
                try {
                    const url = `${GOOGLE_SHEET_ORDERS_URL}&timestamp=${new Date().getTime()}`;
                    const response = await fetchWithRetry(url);
                    const csvText = await response.text();
                    const lines = csvText.trim().split('\n').filter(Boolean);
                    if (lines.length <= 1) { 
                        incomingOrders = [];
                        renderOrders();
                        return;
                    }
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    const newOrders = lines.slice(1).map(line => {
                        // Advanced CSV parsing to handle commas inside quotes
                        const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(v => v.replace(/^"|"$/g, '').trim());
                        let order = {};
                        headers.forEach((header, index) => {
                            order[header] = values[index] || '';
                        });
                        return order;
                    }).filter(o => o.orderId);

                    if (JSON.stringify(newOrders) !== JSON.stringify(incomingOrders)) {
                        incomingOrders = newOrders;
                        renderOrders();
                    }
                } catch (error) {
                    console.error('Gagal mengambil data pesanan:', error);
                    DOM.orderList.innerHTML = `<p style="color: var(--red-700); text-align: center;">Gagal memuat pesanan.</p>`;
                }
            }
            
            // --- FUNGSI RENDER ---
            const renderProducts = (productsToRender) => {
                DOM.productList.innerHTML = '';
                if (productsToRender.length === 0) {
                    DOM.productList.innerHTML = '<p>Produk tidak ditemukan.</p>';
                    return;
                }
                productsToRender.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `<h3>${product.name}</h3><p>${formatCurrency(product.price)}</p>`;
                    card.addEventListener('click', () => app.addToCart(product));
                    DOM.productList.appendChild(card);
                });
            };

            const renderCart = () => {
                DOM.cartItems.innerHTML = '';
                if (cart.length === 0) {
                    DOM.emptyCart.style.display = 'flex';
                } else {
                    DOM.emptyCart.style.display = 'none';
                    cart.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'cart-item';
                        itemEl.innerHTML = `
                            <div>
                                <p style="font-weight: 600; margin: 0;">${item.name}</p>
                                <p style="margin: 0.25rem 0;">${formatCurrency(item.price)}</p>
                            </div>
                            <div class="cart-item-controls">
                                <button data-id="${item.id}" class="decrease-qty">-</button>
                                <span>${item.quantity}</span>
                                <button data-id="${item.id}" class="increase-qty">+</button>
                                <button data-id="${item.id}" class="remove-btn">&times;</button>
                            </div>
                        `;
                        DOM.cartItems.appendChild(itemEl);
                    });
                }
                updateSummary();
            };

            const renderOrders = () => {
                DOM.orderList.innerHTML = '';
                DOM.orderCount.textContent = incomingOrders.length;

                if (incomingOrders.length === 0) {
                    DOM.emptyOrder.style.display = 'flex';
                    DOM.emptyOrder.innerHTML = '<p>Belum ada pesanan masuk...</p>';
                } else {
                    DOM.emptyOrder.style.display = 'none';
                    const sortedOrders = [...incomingOrders].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    sortedOrders.forEach(order => {
                        const orderCard = document.createElement('div');
                        orderCard.className = 'order-card';
                        let itemsText = 'Tidak ada item';
                        try {
                           // Handle JSON string that might be double-quoted
                           const cleanedItemsString = order.items.replace(/^"|"$/g, '').replace(/\\"/g, '"');
                           const items = JSON.parse(cleanedItemsString);
                           itemsText = items.map(item => `${item.quantity}x ${item.name}`).join(', ');
                        } catch(e) { 
                           console.warn("Gagal parsing items JSON:", order.items, e);
                           itemsText = order.items.replace(/\\"/g, '"');
                        }
                        const orderTime = new Date(order.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

                        orderCard.innerHTML = `
                            <div class="order-card-header">
                                <h3>${order.customerName || 'No Name'}</h3>
                                <span>${orderTime}</span>
                            </div>
                            <div class="order-card-body">
                                <p><strong>Tipe:</strong> ${order.orderType || 'N/A'}</p>
                                <p class="order-card-items">${itemsText}</p>
                            </div>
                            <div class="order-card-footer">
                                ${formatCurrency(order.totalAmount || 0)}
                            </div>
                        `;
                        DOM.orderList.appendChild(orderCard);
                    });
                }
            };
            
            // --- FUNGSI PEMBANTU ---
            const updateSummary = () => {
                const subtotal = cart.reduce((acc, item) => acc + item.price * item.quantity, 0);
                totalAmount = subtotal;
                DOM.subtotal.textContent = formatCurrency(subtotal);
                DOM.total.textContent = formatCurrency(totalAmount);
                DOM.payButton.disabled = cart.length === 0;
            };

            const handleSearch = (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = allProducts.filter(p => p.name.toLowerCase().includes(query));
                renderProducts(filtered);
            };

            const updateChange = () => {
                const cash = parseInt(DOM.cashAmountInput.value.replace(/[^0-9]/g, ''), 10) || 0;
                const change = cash - totalAmount;
                DOM.changeAmount.textContent = formatCurrency(change > 0 ? change : 0);
                DOM.processPaymentBtn.disabled = change < 0;
            };
            
            const saveSalesData = () => localStorage.setItem('salesData', JSON.stringify(salesData));
            const loadSalesData = () => { salesData = JSON.parse(localStorage.getItem('salesData')) || []; };
            const setupQrisImage = () => { DOM.qrisImage.src = QRIS_IMAGE_URL; };

            const app = {
                addToCart: (product) => {
                    const existing = cart.find(item => item.id === product.id);
                    if (existing) {
                        existing.quantity++;
                    } else {
                        cart.push({ ...product, quantity: 1 });
                    }
                    renderCart();
                },
                updateQuantity: (id, amount) => {
                    const item = cart.find(item => item.id === id);
                    if (item) {
                        item.quantity += amount;
                        if (item.quantity <= 0) {
                            cart = cart.filter(i => i.id !== id);
                        }
                    }
                    renderCart();
                },
                removeFromCart: (id) => {
                    cart = cart.filter(item => item.id !== id);
                    renderCart();
                },
                openPaymentModal: () => {
                    DOM.modalTotal.textContent = formatCurrency(totalAmount);
                    app.selectPaymentMethod('cash');
                    DOM.cashAmountInput.value = '';
                    updateChange();
                    DOM.paymentModal.classList.remove('hidden');
                },
                closePaymentModal: () => DOM.paymentModal.classList.add('hidden'),
                selectPaymentMethod: (method) => {
                    currentPaymentMethod = method;
                    if (method === 'cash') {
                        DOM.methodCash.classList.add('selected');
                        DOM.methodQris.classList.remove('selected');
                        DOM.cashContainer.classList.remove('hidden');
                        DOM.qrisContainer.classList.add('hidden');
                        DOM.processPaymentBtn.disabled = (parseInt(DOM.cashAmountInput.value.replace(/[^0-9]/g, ''), 10) || 0) < totalAmount;
                    } else {
                        DOM.methodCash.classList.remove('selected');
                        DOM.methodQris.classList.add('selected');
                        DOM.cashContainer.classList.add('hidden');
                        DOM.qrisContainer.classList.remove('hidden');
                        DOM.processPaymentBtn.disabled = false;
                    }
                },
                processPayment: async () => {
                    const sale = {
                        timestamp: new Date().toISOString(),
                        items: cart,
                        total: totalAmount,
                        paymentMethod: currentPaymentMethod,
                    };

                    DOM.processPaymentBtn.disabled = true;
                    DOM.processPaymentBtn.textContent = 'Memproses...';

                    try {
                        // Kirim ke Google Apps Script
                        await fetch(GOOGLE_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                type: 'offlineSale',
                                data: sale
                            })
                        });
                        
                        salesData.push(sale);
                        saveSalesData();
                        app.showReceipt(sale);
                        cart = [];
                        renderCart();
                    } catch (error) {
                        console.error("Gagal mengirim data penjualan:", error);
                        alert("Gagal menyimpan penjualan. Transaksi akan disimpan lokal.");
                        salesData.push(sale); // Simpan lokal jika gagal kirim
                        saveSalesData();
                        app.showReceipt(sale);
                        cart = [];
                        renderCart();
                    } finally {
                        DOM.processPaymentBtn.disabled = false;
                        DOM.processPaymentBtn.textContent = 'Proses';
                        app.closePaymentModal();
                    }
                },
                showReceipt: (sale) => {
                    let itemsHtml = sale.items.map(item => `
                        <tr>
                            <td>${item.name}</td>
                            <td style="text-align:center;">${item.quantity}</td>
                            <td style="text-align:right;">${(item.price * item.quantity).toLocaleString('id-ID')}</td>
                        </tr>
                    `).join('');
                    
                    DOM.receiptContent.innerHTML = `
                        <h3 style="text-align:center;">DAPUR OMAH</h3>
                        <p style="text-align:center; font-size: 0.8em;">Struk Pembelian</p>
                        <hr>
                        <p>Waktu: ${new Date(sale.timestamp).toLocaleString('id-ID')}</p>
                        <table style="width:100%; font-size: 0.9em;">
                           <thead><tr><th>Item</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Subtotal</th></tr></thead>
                           <tbody>${itemsHtml}</tbody>
                        </table>
                        <hr>
                        <p style="text-align:right;"><strong>Total: ${formatCurrency(sale.total)}</strong></p>
                        <p style="text-align:right;">Metode: ${sale.paymentMethod}</p>
                        <p style="text-align:center; margin-top: 1.5rem;">Terima kasih!</p>
                    `;
                    DOM.receiptModal.classList.remove('hidden');
                },
                closeReceiptModal: () => DOM.receiptModal.classList.add('hidden'),
                printReceipt: () => {
                    const receipt = DOM.receiptContent.innerHTML;
                    const win = window.open('', '_blank');
                    win.document.write(`<html><head><title>Struk</title><style>body{font-family: monospace;}</style></head><body>${receipt}</body></html>`);
                    win.document.close();
                    win.print();
                    win.close();
                },
                openSalesReportModal: () => {
                    DOM.salesReportBody.innerHTML = '';
                    const sortedSales = [...salesData].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                    sortedSales.forEach(sale => {
                        const row = document.createElement('tr');
                        const totalItems = sale.items.reduce((sum, item) => sum + item.quantity, 0);
                        row.innerHTML = `<td>${new Date(sale.timestamp).toLocaleString('id-ID')}</td><td>${totalItems} item</td><td>${formatCurrency(sale.total)}</td>`;
                        DOM.salesReportBody.appendChild(row);
                    });
                    const totalRevenue = salesData.reduce((acc, sale) => acc + sale.total, 0);
                    DOM.reportSummary.textContent = `${formatCurrency(totalRevenue)}`;
                    DOM.salesReportModal.classList.remove('hidden');
                },
                closeSalesReportModal: () => DOM.salesReportModal.classList.add('hidden'),
                clearSalesReport: () => {
                    if (confirm("Anda yakin ingin menghapus semua data laporan penjualan? Aksi ini tidak dapat dibatalkan.")) {
                        salesData = [];
                        saveSalesData();
                        app.openSalesReportModal();
                    }
                }
            };

            // --- EVENT LISTENERS ---
            DOM.cartItems.addEventListener('click', (e) => {
                const id = e.target.dataset.id;
                if (e.target.classList.contains('increase-qty')) app.updateQuantity(id, 1);
                if (e.target.classList.contains('decrease-qty')) app.updateQuantity(id, -1);
                if (e.target.classList.contains('remove-btn')) app.removeFromCart(id);
            });
            DOM.payButton.addEventListener('click', app.openPaymentModal);
            DOM.searchInput.addEventListener('input', handleSearch);
            DOM.methodCash.addEventListener('click', () => app.selectPaymentMethod('cash'));
            DOM.methodQris.addEventListener('click', () => app.selectPaymentMethod('qris'));
            DOM.processPaymentBtn.addEventListener('click', app.processPayment);
            DOM.cancelPaymentBtn.addEventListener('click', app.closePaymentModal);
            DOM.cashAmountInput.addEventListener('input', updateChange);
            DOM.closeReceiptBtn.addEventListener('click', app.closeReceiptModal);
            DOM.printReceiptBtn.addEventListener('click', app.printReceipt);
            DOM.salesReportBtn.addEventListener('click', app.openSalesReportModal);
            DOM.closeReportBtn.addEventListener('click', app.closeSalesReportModal);
            DOM.clearReportBtn.addEventListener('click', app.clearSalesReport);
            
            // --- INISIALISASI ---
            function initialize() {
                loadSalesData();
                fetchProducts();
                fetchOrders(); 
                setInterval(fetchOrders, 15000); // Cek pesanan baru setiap 15 detik
                setupQrisImage();
                renderCart();
            }
            
            initialize();
        });
    </script>
</body>
</html>


